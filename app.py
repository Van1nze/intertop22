import logging
import os
import re
from typing import Dict, List, Optional, Any

import requests
from fastapi import FastAPI, Header, HTTPException
from pydantic import BaseModel
from openai import OpenAI

# ============================================================
# –ù–ê–°–¢–†–û–ô–ö–ò
# ============================================================

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
if not OPENAI_API_KEY:
    raise RuntimeError("OPENAI_API_KEY is not set")

# –ú–æ–∂–Ω–æ –≤—ã—Å—Ç–∞–≤–∏—Ç—å gpt-4o-mini –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o")
AI_WEBHOOK_SECRET = os.getenv("AI_WEBHOOK_SECRET")  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è SendPulse

client = OpenAI(api_key=OPENAI_API_KEY)

logging.basicConfig(
    level=logging.INFO,
    format="[%(asctime)s] [%(levelname)s] %(name)s: %(message)s",
)

# ============================================================
# –ó–ê–ì–†–£–ó–ö–ê –õ–û–ö–ê–õ–¨–ù–´–• –§–ê–ô–õ–û–í (–ö–ê–ö –í Intertop.py)
# ============================================================


def load(filename: str) -> str:
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ UTF-8."""
    try:
        with open(filename, "r", encoding="utf-8") as f:
            return f.read()
    except Exception as e:
        logging.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å %s: %s", filename, e)
        return ""


ADDR = load("–ê–¥—Ä–µ—Å–∞ –º–∞–≥–∞–∑–∏–Ω–∞.txt")
BONUS = load("–ë–æ–Ω—É—Å—ã.txt")
VAC = load("–í–∞–∫–∞–Ω—Å–∏—è.txt")
RET = load("–í–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞.txt")
WAR = load("–ì–∞—Ä–∞–Ω—Ç–∏—è.txt")
DEL = load("–î–æ—Å—Ç–∞–≤–∫–∞.txt")
OFR = load("–û—Ñ–µ—Ä—Ç–∞.txt")
PRT = load("–ü–∞—Ä—Ç–Ω–µ—Ä—ã.txt")
CERT = load("–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç.txt")
LAW = load("–ê–¥–≤–æ–∫–∞—Ç.txt")

INFO_URLS = {
    "delivery": "https://intertop.kz/ru-kz/info/payment/",
    "return": "https://intertop.kz/ru-kz/info/return/",
    "bonus": "https://intertop.kz/ru-kz/info/intertop-plus/",
    "warranty": "https://intertop.kz/ru-kz/info/garantii/",
    "offer": "https://intertop.kz/ru-kz/info/offerta/",
    "work": "https://intertop.kz/ru-kz/info/work/",
    "about": "https://intertop.kz/ru-kz/info/about/",
    "buycert": "https://intertop.kz/ru-kz/info/buycertificate/",
    "brands": "https://intertop.kz/ru-kz/brands/",
}

# ============================================================
# –ü–ê–ú–Ø–¢–¨ –ü–û –ö–û–ù–¢–ê–ö–¢–£ (–ü–û contact_id / user_id)
# ============================================================

# –†–µ–∂–∏–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: "faq" | "style" | "lawyer"
state: Dict[str, str] = {}

# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è GPT
dialog_history: Dict[str, List[Dict[str, str]]] = {}

# –ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞: –ø–æ–ª, —Ä–∞–∑–º–µ—Ä, –±—Ä–µ–Ω–¥—ã, –±—é–¥–∂–µ—Ç
user_profile: Dict[str, Dict[str, Any]] = {}

# –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —è–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: "ru" | "en" | "kk"
user_lang: Dict[str, str] = {}

# –ö—ç—à —Å—Ç—Ä–∞–Ω–∏—Ü —Å–∞–π—Ç–∞
_page_cache: Dict[str, str] = {}

# ============================================================
# –§–ò–õ–¨–¢–† –û–ü–ê–°–ù–´–• / –ù–ï–ü–†–û–§–ò–õ–¨–ù–´–• –¢–ï–ú
# ============================================================


def is_hard_offtopic(text: str) -> bool:
    t = text.lower()
    bad_words = [
        "–ª–µ–∫–∞—Ä—Å—Ç–≤",
        "—Ç–∞–±–ª–µ—Ç–∫",
        "—Å–∏–º–ø—Ç–æ–º",
        "–¥–∏–∞–≥–Ω–æ–∑",
        "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä",
        "–¥–∞–≤–ª–µ–Ω–∏",
        "–∏–Ω—Å—É–ª—å—Ç",
        "–∏–Ω—Ñ–∞—Ä–∫—Ç",
        "–æ–ø—É—Ö–æ–ª",
        "–æ–Ω–∫–æ–ª–æ–≥",
        "—Å–∞–º–æ—É–±–∏",
        "—Å—É–∏—Ü–∏–¥",
        "–ø–æ–∫–æ–Ω—á–∏—Ç—å —Å —Å–æ–±–æ–π",
        "—É–±–∏—Ç—å —Å–µ–±—è",
        "–Ω–∞–≤—Ä–µ–¥–∏—Ç—å —Å–µ–±–µ",
    ]
    return any(w in t for w in bad_words)


# ============================================================
# –¢–ï–ö–°–¢–´ –° –°–ê–ô–¢–ê
# ============================================================


def fetch_page_text(url: str, max_len: int = 3500) -> str:
    """–ì—Ä—É–±–æ–µ –æ—á–∏—â–µ–Ω–∏–µ HTML ‚Üí –ø–ª–æ—Å–∫–∏–π —Ç–µ–∫—Å—Ç, —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ GPT."""
    if not url:
        return ""
    if url in _page_cache:
        return _page_cache[url]

    try:
        resp = requests.get(url, timeout=5)
        resp.raise_for_status()
        html = resp.text
        html = re.sub(r"(?is)<(script|style).*?>.*?</\1>", " ", html)
        text = re.sub(r"(?s)<.*?>", " ", html)
        text = re.sub(r"\s+", " ", text).strip()[:max_len]
        _page_cache[url] = text
        return text
    except Exception as e:
        logging.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å %s: %s", url, e)
        return ""


def build_extra_context_for_text(text: str) -> str:
    """–ü–æ–¥–º–µ—à–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏ (–¥–æ—Å—Ç–∞–≤–∫–∞, –≤–æ–∑–≤—Ä–∞—Ç, –±–æ–Ω—É—Å—ã –∏ —Ç.–ø.) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ø—Ä–æ—Å–∞."""
    t = text.lower()
    parts: List[str] = []

    # –î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞
    if any(
        k in t
        for k in [
            "–¥–æ—Å—Ç–∞–≤–∫",
            "–∫—É—Ä—å–µ—Ä",
            "—Å–∞–º–æ–≤—ã–≤–æ–∑",
            "kaspi",
            "–æ–ø–ª–∞—Ç",
            "kaspi red",
            "kaspi qr",
        ]
    ):
        if DEL:
            parts.append("=== –î–û–°–¢–ê–í–ö–ê –ò –û–ü–õ–ê–¢–ê (—Ñ–∞–π–ª) ===\n" + DEL)
        parts.append(
            "=== –î–û–°–¢–ê–í–ö–ê –ò –û–ü–õ–ê–¢–ê (—Å–∞–π—Ç) ===\n"
            + fetch_page_text(INFO_URLS["delivery"])
        )

    # –í–æ–∑–≤—Ä–∞—Ç
    if any(k in t for k in ["–≤–æ–∑–≤—Ä–∞—Ç", "–æ–±–º–µ–Ω", "–≤–µ—Ä–Ω—É—Ç—å", "—Ä–µ–∫–ª–∞–º–∞—Ü–∏"]):
        if RET:
            parts.append("=== –í–û–ó–í–†–ê–¢ (—Ñ–∞–π–ª) ===\n" + RET)
        parts.append("=== –í–û–ó–í–†–ê–¢ (—Å–∞–π—Ç) ===\n" + fetch_page_text(INFO_URLS["return"]))

    # –ì–∞—Ä–∞–Ω—Ç–∏–∏
    if any(k in t for k in ["–≥–∞—Ä–∞–Ω—Ç–∏", "–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π", "–±—Ä–∞–∫", "–Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω"]):
        if WAR:
            parts.append("=== –ì–ê–†–ê–ù–¢–ò–ò (—Ñ–∞–π–ª) ===\n" + WAR)
        parts.append(
            "=== –ì–ê–†–ê–ù–¢–ò–ò (—Å–∞–π—Ç) ===\n" + fetch_page_text(INFO_URLS["warranty"])
        )

    # –ë–æ–Ω—É—Å—ã / –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    if any(
        k in t
        for k in [
            "–±–æ–Ω—É—Å",
            "bonus",
            "intertop plus",
            "–∏–Ω—Ç–µ—Ä—Ç–æ–ø –ø–ª—é—Å",
            "–∫–∞—Ä—Ç",
            "–∫–µ—à–±–µ–∫",
            "–∫—ç—à–±—ç–∫",
        ]
    ):
        if BONUS:
            parts.append("=== –ë–û–ù–£–°–´ (—Ñ–∞–π–ª) ===\n" + BONUS)
        parts.append(
            "=== –ë–û–ù–£–°–´ (—Å–∞–π—Ç) ===\n" + fetch_page_text(INFO_URLS["bonus"])
        )

    # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
    if any(k in t for k in ["—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç", "–ø–æ–¥–∞—Ä–æ—á–Ω", "gift card", "—Å–µ—Ä—Ç–∏–∫"]):
        if CERT:
            parts.append("=== –°–ï–†–¢–ò–§–ò–ö–ê–¢–´ (—Ñ–∞–π–ª) ===\n" + CERT)
        parts.append(
            "=== –°–ï–†–¢–ò–§–ò–ö–ê–¢–´ (—Å–∞–π—Ç) ===\n"
            + fetch_page_text(INFO_URLS["buycert"])
        )

    # –û—Ñ–µ—Ä—Ç–∞
    if any(k in t for k in ["–æ—Ñ–µ—Ä—Ç", "–¥–æ–≥–æ–≤–æ—Ä", "—É—Å–ª–æ–≤–∏—è –ø–æ–∫—É–ø–∫", "–ø—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞"]):
        if OFR:
            parts.append("=== –û–§–ï–†–¢–ê (—Ñ–∞–π–ª) ===\n" + OFR)
        parts.append("=== –û–§–ï–†–¢–ê (—Å–∞–π—Ç) ===\n" + fetch_page_text(INFO_URLS["offer"]))

    # –í–∞–∫–∞–Ω—Å–∏–∏
    if any(k in t for k in ["–≤–∞–∫–∞–Ω—Å–∏", "—Ä–∞–±–æ—Ç–∞", "–∫–∞—Ä—å–µ—Ä", "hr", "—Ä–µ–∑—é–º–µ"]):
        if VAC:
            parts.append("=== –í–ê–ö–ê–ù–°–ò–ò (—Ñ–∞–π–ª) ===\n" + VAC)
        parts.append("=== –í–ê–ö–ê–ù–°–ò–ò (—Å–∞–π—Ç) ===\n" + fetch_page_text(INFO_URLS["work"]))

    # –ü–∞—Ä—Ç–Ω—ë—Ä—ã / marketplace
    if any(k in t for k in ["–ø–∞—Ä—Ç–Ω–µ—Ä", "–ø–∞—Ä—Ç–Ω—ë—Ä", "marketplace", "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"]):
        if PRT:
            parts.append("=== –ü–ê–†–¢–ù–Å–†–´ (—Ñ–∞–π–ª) ===\n" + PRT)
        parts.append(
            "=== –ë–†–ï–ù–î–´ / MARKETPLACE (—Å–∞–π—Ç) ===\n"
            + fetch_page_text(INFO_URLS["brands"])
        )

    # –û –∫–æ–º–ø–∞–Ω–∏–∏
    if any(k in t for k in ["–æ –∫–æ–º–ø–∞–Ω–∏–∏", "–æ –≤–∞—Å", "—á—Ç–æ –∑–∞ intertop", "–∫—Ç–æ –≤—ã —Ç–∞–∫–∏–µ"]):
        parts.append("=== –û –ù–ê–° (—Å–∞–π—Ç) ===\n" + fetch_page_text(INFO_URLS["about"]))

    return "\n\n".join(p for p in parts if p.strip())


# ============================================================
# –î–ï–¢–ï–ö–¢ –Ø–ó–´–ö–ê, –ü–†–û–§–ò–õ–¨, –¢–û–í–ê–†–ù–´–ï –ó–ê–ü–†–û–°–´
# ============================================================


def detect_language(text: str) -> str:
    t = text.lower()
    if re.search(r"[“õ”©”ô—ñ“£“ì“Ø“±“ª]", t):
        return "kk"
    if re.search(r"[a-z]", t) and not re.search(r"[–∞-—è—ë]", t):
        return "en"
    return "ru"


PRODUCT_KEYWORDS = [
    "–∫—Ä–æ—Å—Å–æ–≤–∫",
    "–∫–µ–¥—ã",
    "–±–æ—Ç–∏–Ω–∫",
    "–±–æ—Ç–∏–ª—å–æ–Ω",
    "—Ç—É—Ñ–ª",
    "–ª–æ—Ñ–µ—Ä",
    "–ª–æ—Ñ–µ—Ä—ã",
    "—Å–∞–ø–æ–≥",
    "–±–æ—Ç—Ñ–æ—Ä",
    "—Å–∞–Ω–¥–∞–ª",
    "—Å–ª–∞–Ω—Ü",
    "—à–ª—ë–ø–∫",
    "—à–ª–µ–ø–∫",
    "—Å–ª–∏–ø–æ–Ω—ã",
    "–∫—É—Ä—Ç–∫",
    "–ø—É—Ö–æ–≤–∏–∫",
    "–ø–∞–ª—å—Ç–æ",
    "—Ö—É–¥–∏",
    "—Ç–æ–ª—Å—Ç–æ–≤–∫",
    "—Ñ—É—Ç–±–æ–ª–∫",
    "–¥–∂–∏–Ω—Å",
    "–±—Ä—é–∫",
    "vans",
    "timberland",
    "geox",
    "skechers",
    "clarks",
    "armani",
    "ea7",
    "north face",
    "the north face",
    "nike",
    "adidas",
    "puma",
]

BUY_TRIGGERS = [
    "—Ö–æ—á—É",
    "–Ω—É–∂–Ω",
    "–ø–æ–¥–±–µ—Ä–∏",
    "–ø–æ–¥–æ–±—Ä–∞—Ç—å",
    "–ø–æ—Å–æ–≤–µ—Ç—É–π",
    "–Ω–∞–π–¥–∏",
    "–∏—â—É",
    "–∫—É–ø–∏—Ç—å",
]


def is_product_query(text: str) -> bool:
    t = text.lower()
    return any(k in t for k in PRODUCT_KEYWORDS) or any(
        k in t for k in BUY_TRIGGERS
    )


BRAND_KEYWORDS = {
    "vans": "Vans",
    "timberland": "Timberland",
    "geox": "Geox",
    "skechers": "Skechers",
    "clarks": "Clarks",
    "armani": "Armani",
    "ea7": "EA7",
    "north face": "The North Face",
    "the north face": "The North Face",
    "nike": "Nike",
    "adidas": "Adidas",
    "puma": "Puma",
}


def update_profile_from_text(user_id: str, text: str) -> None:
    t = text.lower()
    profile = user_profile.get(user_id, {})

    if "–º—É–∂—Å–∫" in t:
        profile["gender"] = "–º—É–∂—Å–∫–æ–π"
    elif "–∂–µ–Ω—Å–∫" in t:
        profile["gender"] = "–∂–µ–Ω—Å–∫–∏–π"
    elif any(w in t for w in ["–¥–µ—Ç—Å–∫", "—Ä–µ–±—ë–Ω", "—Ä–µ–±–µ–Ω", "kid", "kids"]):
        profile["gender"] = "–¥–µ—Ç—Å–∫–∏–π"

    size_match = re.search(r"(\d{2})\s*(?:—Ä–∞–∑–º–µ—Ä)?", t)
    if size_match:
        profile["size"] = size_match.group(1)

    budget_match = re.search(r"–¥–æ\s+([\d\s]+)", t)
    if budget_match:
        profile["budget"] = "–¥–æ " + budget_match.group(1).strip()

    brands: List[str] = profile.get("brands", [])
    for key, nice in BRAND_KEYWORDS.items():
        if key in t and nice not in brands:
            brands.append(nice)
    if brands:
        profile["brands"] = brands

    if profile:
        user_profile[user_id] = profile


# ============================================================
# GPT-–ú–û–ó–ì (–∞–¥–∞–ø—Ç–∞—Ü–∏—è —Ç–≤–æ–µ–≥–æ ask() –ø–æ–¥ webhook)
# ============================================================


def ask(
    user_id: str,
    text: str,
    mode: str = "faq",
    extra: str = "",
) -> str:
    forced_lang = user_lang.get(user_id)
    if forced_lang:
        lang_code = forced_lang
    else:
        lang_code = detect_language(text)

    lang_label = {
        "ru": "Russian",
        "en": "English",
        "kk": "Kazakh",
    }.get(lang_code, "Russian")

    system = (
        "–¢—ã ‚Äî —É–º–Ω—ã–π, —Ç–∞–∫—Ç–∏—á–Ω—ã–π –∏ –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π –±—Ä–µ–Ω–¥-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–µ—Ç–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ INTERTOP –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ.\n"
        "–¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å —Ä—É—Å—Å–∫–∏–π, –∫–∞–∑–∞—Ö—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ –∏ –º–æ–∂–µ—à—å —Å–≤–æ–±–æ–¥–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –Ω–∏–º–∏.\n\n"
        "–¢–í–û–Ø –¢–ï–ú–ê–¢–ò–ö–ê –ñ–Å–°–¢–ö–û –û–ì–†–ê–ù–ò–ß–ï–ù–ê: —Ç–æ–ª—å–∫–æ INTERTOP –∏ –≤—Å—ë, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –ø–æ–∫—É–ø–∫–∞–º–∏ –∏ —Å–µ—Ä–≤–∏—Å–æ–º.\n"
        "–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Ç–µ–º—ã: –æ–±—É–≤—å, –æ–¥–µ–∂–¥–∞, –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã, –±—Ä–µ–Ω–¥—ã, –ø–æ–¥–±–æ—Ä –æ–±—Ä–∞–∑–æ–≤, —Ä–∞–∑–º–µ—Ä—ã, —É—Ö–æ–¥ –∑–∞ –æ–±—É–≤—å—é –∏ –æ–¥–µ–∂–¥–æ–π, "
        "–∑–∞–∫–∞–∑—ã, –æ–ø–ª–∞—Ç–∞, –¥–æ—Å—Ç–∞–≤–∫–∞, –≤–æ–∑–≤—Ä–∞—Ç, –≥–∞—Ä–∞–Ω—Ç–∏—è, —Ä–µ–∫–ª–∞–º–∞—Ü–∏–∏, –±–æ–Ω—É—Å—ã, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –º–∞–≥–∞–∑–∏–Ω—ã, –≤–∞–∫–∞–Ω—Å–∏–∏, –ø–∞—Ä—Ç–Ω—ë—Ä—ã Marketplace.\n"
        "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ù–ï –ø—Ä–æ INTERTOP –∏ –Ω–µ –ø—Ä–æ –ø–æ–∫—É–ø–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º—É—Å–æ—Ä, —Ä–µ–º–æ–Ω—Ç, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –∑–¥–æ—Ä–æ–≤—å–µ, –ø–æ–ª–∏—Ç–∏–∫–∞, –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ —Ç.–ø.) ‚Äî "
        "–Ω–µ –æ—Ç–≤–µ—á–∞–π –ø–æ —Å—É—Ç–∏, –∞ –º—è–≥–∫–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å —Ç–æ–ª—å–∫–æ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ INTERTOP –∏ –ø–æ–∫—É–ø–∫–∞–º.\n\n"
        f"–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {lang_label}. "
        "–û—Ç–≤–µ—á–∞–π –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –Ω–∞ —ç—Ç–æ–º —è–∑—ã–∫–µ. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–º–µ—à–∞–Ω–Ω—ã–π ‚Äî –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º.\n\n"
        "–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:\n"
        "- –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –±–µ–∑ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ—Å—Ç–∏;\n"
        "- –ø–æ–Ω—è—Ç–Ω—ã–µ, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ —Å–ª–æ–∂–Ω–æ–≥–æ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞;\n"
        "- –ª—ë–≥–∫–∏–π —é–º–æ—Ä –∏ —ç–º–æ–¥–∑–∏ —É–º–µ—Å—Ç–Ω—ã, –Ω–æ –Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π (–æ–±—ã—á–Ω–æ 1‚Äì3 —Å–º–∞–π–ª–∏–∫–∞ –Ω–∞ –æ—Ç–≤–µ—Ç –º–∞–∫—Å–∏–º—É–º);\n"
        "- –≤—Å–µ–≥–¥–∞ –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞, –Ω–æ —Å—Ç—Ä–æ–≥–æ –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–∞–≤–∏–ª INTERTOP –∏ –ó–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –†–ö.\n\n"
        "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–≤–µ—á–∞–π –ö–û–†–û–¢–ö–û: –ø—Ä–∏–º–µ—Ä–Ω–æ 3‚Äì6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏–ª–∏ –¥–æ 6 –ø—É–Ω–∫—Ç–æ–≤ —Å–ø–∏—Å–∫–∞.\n"
        "–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –ø—Ä–æ—Å–∏—Ç ¬´–ø–æ–¥—Ä–æ–±–Ω–µ–µ¬ª, ¬´–æ—á–µ–Ω—å –¥–µ—Ç–∞–ª—å–Ω–æ¬ª, ¬´–ø–æ —à–∞–≥–∞–º¬ª ‚Äî –º–æ–∂–µ—à—å –¥–∞—Ç—å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç, –Ω–æ –±–µ–∑ –≤–æ–¥—ã.\n\n"
        "–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç —Ä–∞–∑–º–µ—Ä–∞, –ø–æ–ª–∞, –±—é–¥–∂–µ—Ç–∞, –≥–æ—Ä–æ–¥–∞), "
        "—Å–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π 1‚Äì2 –∫–æ—Ä–æ—Ç–∫–∏—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞, –∞ –ø–æ—Ç–æ–º –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã.\n"
        "–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –∏–ª–∏ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö.\n\n"
        "–ü–æ –º–µ–¥–∏—Ü–∏–Ω–µ, –∑–¥–æ—Ä–æ–≤—å—é, –æ–ø–∞—Å–Ω—ã–º –∏–ª–∏ –Ω–µ–∑–∞–∫–æ–Ω–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º —Å–æ–≤–µ—Ç–æ–≤ –Ω–µ –¥–∞—ë—à—å.\n\n"
        "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π Markdown (–±–µ–∑ HTML-—Ç–µ–≥–æ–≤ –∏ –∫–æ–¥–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤):\n"
        "- —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å–ø–∏—Å–∫–∞–º–∏ `-` –∏–ª–∏ –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π `1.`;\n"
        "- –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ `###` –≤–Ω—É—Ç—Ä–∏ –æ—Ç–≤–µ—Ç–∞;\n"
        "- –≤—ã–¥–µ–ª—è–π –≤–∞–∂–Ω–æ–µ `**–∂–∏—Ä–Ω—ã–º**`.\n\n"
        "–ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ (URL) –≤ —Ç–µ–∫—Å—Ç–µ –ù–ï –ø–∏—à–∏. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –ø—Ä–æ—Å—Ç–æ —É–ø–æ–º—è–Ω–∏, —á—Ç–æ –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –µ—Å—Ç—å "
        "–Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ INTERTOP –∏–ª–∏ –µ—ë –ø–æ–¥—Å–∫–∞–∂—É—Ç –≤ call-—Ü–µ–Ω—Ç—Ä–µ.\n\n"
        "–ê–¥—Ä–µ—Å–∞ –∏ –º–∞–≥–∞–∑–∏–Ω—ã –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π ‚Äî –æ–ø–∏—Ä–∞–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –ø–µ—Ä–µ–¥–∞–ª–∏.\n"
        "–ï—Å–ª–∏ –≤ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–∞—Ö –Ω–µ—Ç —Ç–æ—á–Ω—ã—Ö —Ü–∏—Ñ—Ä (—Å—Ä–æ–∫–∏, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, —Å—É–º–º—ã, —É—Å–ª–æ–≤–∏—è –∞–∫—Ü–∏–π), –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏—Ö: "
        "–ª—É—á—à–µ –º—è–≥–∫–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–ª–∏–µ–Ω—Ç—É —É—Ç–æ—á–Ω–∏—Ç—å –≤ call-—Ü–µ–Ω—Ç—Ä–µ, —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ.\n\n"
        "–í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ, –ø—Ä–µ–¥–ª–æ–∂–∏ –ª–æ–≥–∏—á–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ —Ä–∞–∑–º–µ—Ä, "
        "–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥–±–æ—Ä –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ call-—Ü–µ–Ω—Ç—Ä, –ø—Ä–∏–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω) ‚Äî –º—è–≥–∫–æ –∏ –±–µ–∑ –Ω–∞–≤—è–∑—á–∏–≤—ã—Ö –ø—Ä–æ–¥–∞–∂.\n"
    )

    profile = user_profile.get(user_id)
    if profile:
        system += "\n=== –ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π) ===\n"
        if "gender" in profile:
            system += f"–ü–æ–ª: {profile['gender']}\n"
        if "size" in profile:
            system += f"–†–∞–∑–º–µ—Ä –æ–±—É–≤–∏: {profile['size']}\n"
        if "budget" in profile:
            system += f"–ë—é–¥–∂–µ—Ç: {profile['budget']}\n"
        if profile.get("brands"):
            system += "–õ—é–±–∏–º—ã–µ –±—Ä–µ–Ω–¥—ã: " + ", ".join(profile["brands"]) + "\n"

    if mode == "style":
        system += (
            "\n–°–µ–π—á–∞—Å —É —Ç–µ–±—è —Ä–µ–∂–∏–º <—Å—Ç–∏–ª–∏—Å—Ç–∞>.\n"
            "–§–æ–∫—É—Å ‚Äî –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ –∏ —á–µ—Å—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –∫–ª–∏–µ–Ω—Ç—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø–æ–∫—É–ø–∫–æ–π.\n"
        )
    elif mode == "lawyer":
        system += (
            "\n–°–µ–π—á–∞—Å —É —Ç–µ–±—è —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ —Å–ª–æ–∂–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏/–∂–∞–ª–æ–±–µ.\n"
            "–ì–æ–≤–æ—Ä–∏ —Å–ø–æ–∫–æ–π–Ω–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ —ç–º–ø–∞—Ç–∏—á–Ω–æ, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞.\n"
        )

    if extra:
        system += (
            "\n\n=== –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –±–∞–∑–∞ INTERTOP (—Ñ–∞–π–ª—ã, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã, —Å–∞–π—Ç) ===\n"
            + extra
        )

    messages: List[Dict[str, str]] = [{"role": "system", "content": system}]
    history = dialog_history.get(user_id, [])
    if history:
        messages.extend(history[-10:])

    messages.append({"role": "user", "content": text})

    try:
        resp = client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=messages,
            max_tokens=350,
            temperature=0.25 if mode != "style" else 0.5,
        )
        answer_md = (resp.choices[0].message.content or "").strip()

        history.append({"role": "user", "content": text})
        history.append({"role": "assistant", "content": answer_md})
        dialog_history[user_id] = history[-12:]

        # –í SendPulse –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å Markdown –∫–∞–∫ –µ—Å—Ç—å
        return answer_md
    except Exception:
        logging.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI")
        return (
            "–ù–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–≥—Ä–µ–ª—Å—è –æ—Ç –º–æ–¥–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ üòÖ\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å call-—Ü–µ–Ω—Ç—Ä–æ–º:\n"
            "üìû +7 705 924 11 00."
        )


# ============================================================
# –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–ü–†–û–°–ê –û–¢ SENDPULSE
# ============================================================

LAW_KEYWORDS = [
    "–±—Ä–∞–∫",
    "–≤–µ—Ä–Ω—É—Ç—å",
    "–ø—Ä–µ—Ç–µ–Ω–∑",
    "—Ä–µ–∫–ª–∞–º–∞—Ü–∏",
    "–Ω–∞—Ä—É—à–µ–Ω",
    "–∂–∞–ª–æ–±",
]

STYLE_KEYWORDS = [
    "—Å —á–µ–º –Ω–æ—Å–∏—Ç—å",
    "–∫–∞–∫ –Ω–æ—Å–∏—Ç—å",
    "—Å —á–µ–º –ª—É—á—à–µ",
    "–æ–±—Ä–∞–∑",
    "–ª—É–∫",
    "–ø–æ–¥ —á—Ç–æ –Ω–æ—Å–∏—Ç—å",
    "–ø–æ–¥ —á—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç",
    "–ø–æ–¥–±–µ—Ä–∏ –æ–±—Ä–∞–∑",
    "–∫–∞–∫ —Å–æ—á–µ—Ç–∞—Ç—å",
]


def generate_reply(user_id: str, text: str) -> str:
    t = text.lower()
    current_mode = state.get(user_id, "faq")

    # –ñ—ë—Å—Ç–∫–∏–π –æ—Ñ—Ñ—Ç–æ–ø (–∑–¥–æ—Ä–æ–≤—å–µ –∏ —Ç.–ø.)
    if is_hard_offtopic(t):
        return (
            "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –∑–¥–æ—Ä–æ–≤—å—è –∏ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π —è –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –Ω–µ –º–æ–≥—É üôè\n"
            "–õ—É—á—à–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É –∏–ª–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å–Ω—É—é —Å–ª—É–∂–±—É.\n\n"
            "–ù–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Å–æ–≤–µ—Ç –ø–æ –æ–±—É–≤–∏, –æ–¥–µ–∂–¥–µ –∏–ª–∏ INTERTOP ‚Äî —è –∑–¥–µ—Å—å üòä"
        )

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–µ—Ü-—Ä–µ–∂–∏–º
    if any(w in t for w in LAW_KEYWORDS):
        current_mode = "lawyer"
        state[user_id] = "lawyer"
    elif any(w in t for w in STYLE_KEYWORDS):
        current_mode = "style"
        state[user_id] = "style"

    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    if current_mode == "style" or is_product_query(text):
        update_profile_from_text(user_id, text)

    extra = build_extra_context_for_text(text)
    if current_mode == "lawyer" and LAW:
        extra = (extra + "\n\n=== –®–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤ –∞–¥–≤–æ–∫–∞—Ç–∞ ===\n" + LAW).strip()

    return ask(user_id, text, mode=current_mode, extra=extra)


# ============================================================
# FASTAPI –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
# ============================================================


class AIRequest(BaseModel):
    message: str
    contact_id: Optional[str] = None
    user_id: Optional[str] = None


app = FastAPI()


@app.get("/health")
def health():
    return {"ok": True}


@app.post("/ai")
def ai(req: AIRequest, x_ai_secret: Optional[str] = Header(default=None)):
    # –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
    if AI_WEBHOOK_SECRET and x_ai_secret != AI_WEBHOOK_SECRET:
        raise HTTPException(status_code=401, detail="unauthorized")

    msg = (req.message or "").strip()
    if not msg:
        raise HTTPException(status_code=400, detail="message is required")

    user_key = str(req.contact_id or req.user_id or "anon")
    reply = generate_reply(user_key, msg)

    # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ–≥—Ä–∞–Ω–∏—á–∏–º –¥–ª–∏–Ω—É
    if len(reply) > 3500:
        reply = reply[:3500] + "‚Ä¶"

    return {"reply": reply}
